name: Frontend CI/CD Pipeline (AWS CodePipeline-Inspired)

on:
  push:
    branches: [main, develop, 'feature/**']
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'vite.config.js'
      - '.github/workflows/**'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  DEPLOYMENT_VERSION: ${{ github.sha }}

jobs:
  # ======================
  # STAGE 1: CODE QUALITY
  # ======================
  
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  # ======================
  # STAGE 2: SECURITY
  # ======================
  
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  # ======================
  # STAGE 3: BUILD & TEST
  # ======================
  
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan]
    strategy:
      matrix:
        node-version: [18, 20]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Test build output
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed - dist directory not found"
            exit 1
          fi
          
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå Build failed - index.html not found"
            exit 1
          fi
          
          echo "‚úÖ Build validation passed"

      - name: Upload build artifacts
        if: matrix.node-version == 18
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: dist/
          retention-days: 7

  # ======================
  # STAGE 4: PREVIEW BUILD
  # ======================
  
  preview-build:
    name: Preview Build
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'pull_request'
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: dist/

      - name: Deploy preview
        run: |
          echo "üîç Deploying preview build..."
          echo "Preview URL would be: https://preview-${{ github.event.number }}.deployhub.com"
          # Add preview deployment logic here

  # ======================
  # STAGE 5: DEPLOY STAGING
  # ======================
  
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: https://staging-deployhub-frontend.vercel.app
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: dist/

      - name: Create deployment manifest
        run: |
          echo '{
            "version": "${{ env.DEPLOYMENT_VERSION }}",
            "buildDate": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "buildNumber": "${{ github.run_number }}",
            "branch": "${{ github.ref_name }}",
            "environment": "staging"
          }' > dist/deployment-info.json

      - name: Deploy to Staging
        env:
          VERCEL_STAGING_HOOK: ${{ secrets.VERCEL_STAGING_HOOK }}
        run: |
          if [ -n "$VERCEL_STAGING_HOOK" ]; then
            echo "üöÄ Deploying to staging..."
            RESPONSE=$(curl -X POST "$VERCEL_STAGING_HOOK" -w "%{http_code}" -o /dev/null -s)
            if [ $RESPONSE -eq 200 ]; then
              echo "‚úÖ Staging deployment triggered"
            else
              echo "‚ùå Staging deployment failed with status $RESPONSE"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è VERCEL_STAGING_HOOK not set"
          fi

      - name: Wait for staging deployment
        run: |
          echo "‚è≥ Waiting for staging deployment..."
          sleep 45

      - name: Staging health check
        env:
          STAGING_URL: ${{ secrets.FRONTEND_STAGING_URL }}
        run: |
          echo "üè• Running staging health check..."
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${STAGING_URL})
            if [ $HTTP_STATUS -eq 200 ]; then
              echo "‚úÖ Staging health check passed!"
              exit 0
            fi
            echo "‚è≥ Retry $((RETRY_COUNT+1))/$MAX_RETRIES..."
            sleep 10
            RETRY_COUNT=$((RETRY_COUNT+1))
          done
          
          echo "‚ùå Staging health check failed"
          exit 1

  # ======================
  # STAGE 6: APPROVAL GATE
  # ======================
  
  approve-production:
    name: Approve Production Deployment
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production-approval
    steps:
      - name: Wait for manual approval
        run: |
          echo "‚è∏Ô∏è Awaiting manual approval for production deployment"
          echo "üìä Frontend version: ${{ env.DEPLOYMENT_VERSION }}"

  # ======================
  # STAGE 7: DEPLOY PRODUCTION
  # ======================
  
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: approve-production
    environment:
      name: production
      url: https://deployhub-frontend.vercel.app
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: dist/

      - name: Create production deployment manifest
        run: |
          echo '{
            "version": "${{ env.DEPLOYMENT_VERSION }}",
            "buildDate": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "buildNumber": "${{ github.run_number }}",
            "branch": "${{ github.ref_name }}",
            "environment": "production",
            "deployer": "${{ github.actor }}"
          }' > dist/deployment-info.json

      - name: Deploy to Production
        id: deploy
        env:
          VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}
        run: |
          if [ -n "$VERCEL_DEPLOY_HOOK" ]; then
            echo "üöÄ Triggering production deployment..."
            RESPONSE=$(curl -X POST "$VERCEL_DEPLOY_HOOK" -w "%{http_code}" -o /dev/null -s)
            echo "deploy_status=$RESPONSE" >> $GITHUB_OUTPUT
            
            if [ $RESPONSE -eq 200 ]; then
              echo "‚úÖ Production deployment triggered"
            else
              echo "‚ùå Deployment trigger failed with status $RESPONSE"
              exit 1
            fi
          else
            echo "‚ùå VERCEL_DEPLOY_HOOK not configured"
            exit 1
          fi

      - name: Wait for production deployment
        run: |
          echo "‚è≥ Waiting for production deployment (60 seconds)..."
          sleep 60

      - name: Production health check
        env:
          PROD_URL: ${{ secrets.FRONTEND_PROD_URL }}
        run: |
          echo "üè• Running production health check..."
          MAX_RETRIES=8
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${PROD_URL})
            
            if [ $HTTP_STATUS -eq 200 ]; then
              echo "‚úÖ Production health check passed!"
              
              # Check if deployment info is accessible
              curl -s ${PROD_URL}/deployment-info.json || echo "‚ö†Ô∏è Deployment info not accessible"
              
              exit 0
            fi
            
            echo "‚è≥ Attempt $((RETRY_COUNT+1))/$MAX_RETRIES - Status: $HTTP_STATUS"
            sleep 10
            RETRY_COUNT=$((RETRY_COUNT+1))
          done
          
          echo "‚ùå Production health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Rollback on failure
        if: failure()
        env:
          VERCEL_ROLLBACK_HOOK: ${{ secrets.VERCEL_ROLLBACK_HOOK }}
        run: |
          echo "üîÑ Deployment failed - initiating rollback..."
          
          if [ -n "$VERCEL_ROLLBACK_HOOK" ]; then
            curl -X POST "$VERCEL_ROLLBACK_HOOK"
            echo "‚ö†Ô∏è Rollback initiated"
          else
            echo "‚ùå VERCEL_ROLLBACK_HOOK not configured - manual rollback required"
          fi
          
          exit 1

  # ======================
  # STAGE 8: POST-DEPLOYMENT
  # ======================
  
  post-deployment:
    name: Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy-production
    if: success()
    steps:
      - name: Notify team
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          echo "üì¢ Sending frontend deployment notification..."
          
          NOTIFICATION='{
            "text": "üé® Frontend Deployment Successful!",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Frontend Production Deployment Completed*\n\n‚Ä¢ Version: \`${{ env.DEPLOYMENT_VERSION }}\`\n‚Ä¢ Build: #${{ github.run_number }}\n‚Ä¢ Branch: \`${{ github.ref_name }}\`\n‚Ä¢ Deployed by: ${{ github.actor }}\n‚Ä¢ Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
                }
              }
            ]
          }'
          
          if [ -n "$SLACK_WEBHOOK" ]; then
            curl -X POST "$SLACK_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d "$NOTIFICATION"
            echo "‚úÖ Team notified"
          else
            echo "‚ö†Ô∏è SLACK_WEBHOOK not configured"
          fi

      - name: Update deployment log
        run: |
          echo "üìù Frontend Deployment Summary:"
          echo "=============================="
          echo "Version: ${{ env.DEPLOYMENT_VERSION }}"
          echo "Build: #${{ github.run_number }}"
          echo "Environment: Production"
          echo "Status: ‚úÖ Success"
          echo "Deployed by: ${{ github.actor }}"
          echo "Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "=============================="